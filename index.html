<html>
<head>
    <meta content="text/html; charset=UTF-8" http-equiv="content-type">
    <style type="text/css">ol {
            margin: 0;
            padding: 0
        }

        table td, table th {
            padding: 0
        }

        .c5 {
            color: #000000;
            font-weight: 700;
            text-decoration: none;
            vertical-align: baseline;
            font-size: 18pt;
            font-family: "Arial";
            font-style: normal
        }

        .c3 {
            color: #000000;
            font-weight: 400;
            text-decoration: none;
            vertical-align: baseline;
            font-size: 14pt;
            font-family: "Arial";
            font-style: normal
        }

        .c7 {
            color: #000000;
            font-weight: 400;
            text-decoration: none;
            vertical-align: baseline;
            font-size: 12pt;
            font-family: "Arial";
            font-style: normal
        }

        .c0 {
            padding-top: 0pt;
            padding-bottom: 0pt;
            line-height: 1.15;
            orphans: 2;
            widows: 2;
            text-align: left;
            height: 11pt
        }

        .c1 {
            color: #000000;
            font-weight: 400;
            text-decoration: none;
            vertical-align: baseline;
            font-size: 11pt;
            font-family: "Arial";
            font-style: normal
        }

        .c12 {
            color: #000000;
            text-decoration: none;
            vertical-align: baseline;
            font-size: 24pt;
            font-family: "Arial";
            font-style: normal
        }

        .c10 {
            padding-top: 0pt;
            padding-bottom: 0pt;
            line-height: 1.15;
            orphans: 2;
            widows: 2;
            text-align: center
        }

        .c8 {
            color: #000000;
            text-decoration: none;
            vertical-align: baseline;
            font-size: 11pt;
            font-family: "Arial";
            font-style: normal
        }

        .c2 {
            padding-top: 0pt;
            padding-bottom: 0pt;
            line-height: 1.15;
            orphans: 2;
            widows: 2;
            text-align: left
        }

        .c13 {
            color: #000000;
            text-decoration: none;
            vertical-align: baseline;
            font-size: 14pt;
            font-family: "Arial";
            font-style: normal
        }

        .c9 {
            background-color: #ffffff;
            max-width: 451.4pt;
            padding: 72pt 72pt 72pt 72pt
        }

        .c6 {
            font-weight: 700
        }

        .c4 {
            margin-left: 36pt
        }

        .c11 {
            font-size: 12pt
        }

        .title {
            padding-top: 0pt;
            color: #000000;
            font-size: 26pt;
            padding-bottom: 3pt;
            font-family: "Arial";
            line-height: 1.15;
            page-break-after: avoid;
            orphans: 2;
            widows: 2;
            text-align: left
        }

        .subtitle {
            padding-top: 0pt;
            color: #666666;
            font-size: 15pt;
            padding-bottom: 16pt;
            font-family: "Arial";
            line-height: 1.15;
            page-break-after: avoid;
            orphans: 2;
            widows: 2;
            text-align: left
        }

        li {
            color: #000000;
            font-size: 11pt;
            font-family: "Arial"
        }

        p {
            margin: 0;
            color: #000000;
            font-size: 11pt;
            font-family: "Arial"
        }

        h1 {
            padding-top: 20pt;
            color: #000000;
            font-size: 20pt;
            padding-bottom: 6pt;
            font-family: "Arial";
            line-height: 1.15;
            page-break-after: avoid;
            orphans: 2;
            widows: 2;
            text-align: left
        }

        h2 {
            padding-top: 18pt;
            color: #000000;
            font-size: 16pt;
            padding-bottom: 6pt;
            font-family: "Arial";
            line-height: 1.15;
            page-break-after: avoid;
            orphans: 2;
            widows: 2;
            text-align: left
        }

        h3 {
            padding-top: 16pt;
            color: #434343;
            font-size: 14pt;
            padding-bottom: 4pt;
            font-family: "Arial";
            line-height: 1.15;
            page-break-after: avoid;
            orphans: 2;
            widows: 2;
            text-align: left
        }

        h4 {
            padding-top: 14pt;
            color: #666666;
            font-size: 12pt;
            padding-bottom: 4pt;
            font-family: "Arial";
            line-height: 1.15;
            page-break-after: avoid;
            orphans: 2;
            widows: 2;
            text-align: left
        }

        h5 {
            padding-top: 12pt;
            color: #666666;
            font-size: 11pt;
            padding-bottom: 4pt;
            font-family: "Arial";
            line-height: 1.15;
            page-break-after: avoid;
            orphans: 2;
            widows: 2;
            text-align: left
        }

        h6 {
            padding-top: 12pt;
            color: #666666;
            font-size: 11pt;
            padding-bottom: 4pt;
            font-family: "Arial";
            line-height: 1.15;
            page-break-after: avoid;
            font-style: italic;
            orphans: 2;
            widows: 2;
            text-align: left
        }</style>
</head>
<body class="c9">
<div><p class="c0"><span class="c1"></span></p></div>
<p class="c10"><span class="c6 c12">MANUAL PARA INSTALAÇÃO DO OSM/OSRM/NOMINATIM NO DEBIAN 9 (STRETCH)</span></p>
<p class="c0"><span class="c5"></span></p>
<p class="c0"><span class="c5"></span></p>
<p class="c0"><span class="c5"></span></p>
<p class="c2"><span class="c5">INSTALAR OPEN STREET MAPS (OSM) </span></p>
<p class="c0"><span class="c6 c13"></span></p>
<p class="c2"><span class="c1">TODOS OS COMANDOS ( # ) DEVEM SER EXECUTADOS COMO ROOT</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span
            class="c1">TODOS OS COMANDOS ( $ ) DEVEM SER EXECUTADOS COMO USUÁRIO NO CONTEXTO DAS INSTRUÇÕES</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c3">Atualizar repositórios</span></p>
<p class="c0"><span class="c3"></span></p>
<p class="c2"><span class="c1"># apt update</span></p>
<p class="c2"><span class="c1"># apt upgrade</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c6">OBS:</span><span class="c1">&nbsp;Se a máquina estiver apresentando a seguinte mensagem ao tentar atualizar os repositórios é necessário configurar a linguagem da máquina:</span>
</p>
<p class="c0"><span class="c1"></span></p>
<p class="c2 c4"><span class="c1">perl: warning: Setting locale failed.</span></p>
<p class="c2 c4"><span class="c1">perl: warning: Please check that your locale settings:</span></p>
<p class="c2 c4"><span class="c1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LANGUAGE = "en_US:en",</span></p>
<p class="c2 c4"><span class="c1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LC_ALL = (unset),</span></p>
<p class="c2 c4"><span class="c1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LC_MEASUREMENT = "pt_BR.UTF-8",</span>
</p>
<p class="c2 c4"><span class="c1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LC_PAPER = "pt_BR.UTF-8",</span></p>
<p class="c2 c4"><span class="c1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LC_MONETARY = "pt_BR.UTF-8",</span>
</p>
<p class="c2 c4"><span class="c1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LC_NAME = "pt_BR.UTF-8",</span></p>
<p class="c2 c4"><span class="c1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LC_CTYPE = "pt_BR.UTF-8",</span></p>
<p class="c2 c4"><span class="c1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LC_ADDRESS = "pt_BR.UTF-8",</span></p>
<p class="c2 c4"><span class="c1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LC_NUMERIC = "pt_BR.UTF-8",</span></p>
<p class="c2 c4"><span class="c1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LC_TELEPHONE = "pt_BR.UTF-8",</span>
</p>
<p class="c2 c4"><span
            class="c1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LC_IDENTIFICATION = "pt_BR.UTF-8",</span></p>
<p class="c2 c4"><span class="c1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LC_TIME = "pt_BR.UTF-8",</span></p>
<p class="c2 c4"><span class="c1">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LANG = "en_US.UTF-8"</span></p>
<p class="c2 c4"><span class="c1">&nbsp; &nbsp; are supported and installed on your system.</span></p>
<p class="c2 c4"><span class="c1">perl: warning: Falling back to a fallback locale ("en_US.UTF-8").</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c1">Para resolver basta acessar a configuração de locales com o seguinte comando:</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c1"># dpkg-reconfigure locales</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c1">Selecione en_US e pt_BR.UTF8</span></p>
<p class="c2"><span class="c1">Selecione OK.</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c3">Instalar Base Postgres + Postgis e postgresql-contrib (para hstore)</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c1"># apt install postgresql-9.6-postgis-2.3 postgresql-contrib-9.6</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c3">Remover pacotes desnecessários</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c1"># apt autoremove</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c3">Entrar com usuário postgres</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c1"># su postgres</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c3">Acessar home do postgres (prevenir de estar na home do root)</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c1">$ cd ~</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c3">Criar usuário de banco "osm" e base de dados "gis"</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c1">$ createuser osm</span></p>
<p class="c2"><span class="c1">$ createdb -E UTF8 -O osm gis</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c3">Instalando extensões do postgres (hstore e postgis)</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c1">$ psql -c "CREATE EXTENSION hstore;" -d gis</span></p>
<p class="c2"><span class="c1">$ psql -c "CREATE EXTENSION postgis;" -d gis</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c3">Sair do usuário postgres</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c1">$exit</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c3">Criar um usuário "osm" no Linux</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c1"># adduser osm</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c6">OBS1</span><span class="c1">: A senha pode ser qualquer uma, recomenda-se utilizar a mesma do root.</span>
</p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c6">OBS2</span><span class="c1">: Para evitar rodar os serviços como root, daqui para frente será usado este usuário "osm" que deve ser o mesmo nome do usuário de banco para que a autenticação de banco aconteça por "peer" (automático)</span>
</p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c3">Instalar osm2pgsql para extrair a base de dados do arquivo de mapa</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c1"># apt install osm2pgsql</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c3">Instalar o gerenciador de múltiplas sessões Tmux</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c1"># apt install tmux</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c3">Abrir uma sessão no Tmux, logar como usuario 'osm' e iniciar o download do arquivo de mapa</span>
</p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c1"># tmux </span></p>
<p class="c2"><span class="c1"># su osm</span></p>
<p class="c2"><span class="c1">$ cd ~</span></p>
<p class="c2"><span class="c1">$ wget http://download.geofabrik.de/south-america-latest.osm.pbf</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c6">OBS</span><span class="c1">: Para sair da sessão do tmux sem fechá-la, basta dar o comando "Ctrl+B" e em seguida "D". Para retornar a sessão do tmux basta executar o comando "tmux attach"</span>
</p>
<p class="c2"><span class="c1">(Importante estar como root já que a sessão foi aberta com ele)</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c3">Importar os dados para o Postgres</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c1">$ osm2pgsql --slim -d gis -C 17000 --hstore south-america-latest.osm.pbf</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c3">Sair do tmux (ctrl+B D) e Testar a importação de dados</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c1"># su postgres</span></p>
<p class="c2"><span class="c1">$ psql -d gis -c "select name from planet_osm_point where place='city';"</span></p>
<p class="c2"><span class="c1">$ exit</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c3">Instalar unzip para descompactar arquivos</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c1"># apt install unzip</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c3">Baixar módulo do Apache para renderização das Tiles</span></p>
<p class="c0"><span class="c3"></span></p>
<p class="c2"><span class="c6">OBS</span><span class="c1">: Comandos DEVEM ser executados como “osm”</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c1"># su osm</span></p>
<p class="c2"><span class="c1">$ cd ~</span></p>
<p class="c2"><span class="c1">$ wget https://github.com/openstreetmap/mod_tile/archive/master.zip</span></p>
<p class="c2"><span class="c1">$ unzip master.zip</span></p>
<p class="c2"><span class="c1">$ rm master.zip</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c3">Instalar as dependências </span></p>
<p class="c0"><span class="c3"></span></p>
<p class="c2"><span class="c6">OBS</span><span class="c1">: Comandos DEVEM ser executados como ROOT</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c1">$ exit</span></p>
<p class="c2"><span class="c1"># apt install autoconf libtool libmapnik-dev apache2-dev</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c3">Instalar módulo do apache para renderizar Tiles</span></p>
<p class="c0"><span class="c3"></span></p>
<p class="c2"><span class="c6">OBS</span><span class="c1">: Comandos DEVEM ser executados como “osm”</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c1"># su osm</span></p>
<p class="c2"><span class="c1">$ cd mod_tile-master/</span></p>
<p class="c2"><span class="c1">$ ./autogen.sh</span></p>
<p class="c2"><span class="c1">$ ./configure</span></p>
<p class="c2"><span class="c1">$ make</span></p>
<p class="c2"><span class="c1">$ exit</span></p>
<p class="c2"><span class="c1"># cd /home/osm/mod_tile-master/</span></p>
<p class="c2"><span class="c1"># make install</span></p>
<p class="c2"><span class="c1"># make install-mod_tile</span></p>
<p class="c2"><span class="c1"># cd ..</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c3">Gerar os arquivos de estilo Mapnik</span></p>
<p class="c0"><span class="c3"></span></p>
<p class="c2"><span class="c6">OBS</span><span class="c1">: Comandos DEVEM ser executados como ROOT</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c1"># apt install curl unzip gdal-bin mapnik-utils node-carto</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c3">Baixar e descompactar os arquivos de estilo do mapa</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c1"># su osm</span></p>
<p class="c2"><span class="c1">$ cd ~</span></p>
<p class="c2"><span class="c1">$ wget https://github.com/angelocavallet/HDM-CartoCSS/archive/master.zip</span></p>
<p class="c2"><span class="c1">$ unzip master.zip</span></p>
<p class="c2"><span class="c1">$ rm master.zip</span></p>
<p class="c2"><span class="c1">$ exit</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c3">Retornar a sessão do Tmux e Baixar os contornos e formatos da América do Sul</span></p>
<p class="c0"><span class="c3"></span></p>
<p class="c2"><span class="c6">OBS</span><span class="c1">: Comandos DEVEM ser executados como ROOT</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c1"># tmux attach</span></p>
<p class="c2"><span class="c1"># su osm</span></p>
<p class="c2"><span class="c1">$ cd /home/osm/HDM-CartoCSS-master/DEM/</span></p>
<p class="c2"><span class="c1">$ ./south_america.sh</span></p>
<p class="c2"><span class="c1">$ cd data</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span
            class="c1">$ wget http://data.openstreetmapdata.com/simplified-land-polygons-complete-3857.zip</span></p>
<p class="c2"><span class="c1">$ unzip simplified-land-polygons-complete-3857.zip</span></p>
<p class="c2"><span class="c1">$ rm simplified-land-polygons-complete-3857.zip</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c1">$ wget http://data.openstreetmapdata.com/land-polygons-split-3857.zip</span></p>
<p class="c2"><span class="c1">$ unzip land-polygons-split-3857.zip</span></p>
<p class="c2"><span class="c1">$ rm land-polygons-split-3857.zip</span></p>
<p class="c2"><span class="c1">$ exit</span></p>
<p class="c2"><span class="c1"># exit</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c3">Instalar node-carto para compilar o estilo</span></p>
<p class="c0"><span class="c3"></span></p>
<p class="c2"><span class="c6">OBS</span><span class="c1">: Comandos DEVEM ser executados como ROOT</span></p>
<p class="c0"><span class="c6 c8"></span></p>
<p class="c2"><span class="c1"># npm -g --save install node-carto</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c3">Compilar o estilo HDM-Carto</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c1"># cd ../../</span></p>
<p class="c2"><span class="c1"># carto project.mml &gt; style.xml</span></p>
<p class="c2"><span class="c1"># cd ..</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c3">Configurar Mod_Tile</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c7">Acessar o arquivo de configuração do Renderd</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c1"># nano /usr/local/etc/renderd.conf</span></p>
<p class="c0"><span class="c7"></span></p>
<p class="c2"><span class="c7">Alterar os seguintes itens para os caminhos configurados</span></p>
<p class="c0"><span class="c7"></span></p>
<p class="c2 c4"><span class="c1">XML=/home/osm/HDM-CartoCSS-master/style.xml</span></p>
<p class="c2 c4"><span class="c1">HOST=localhost</span></p>
<p class="c2 c4"><span class="c1">plugins_dir=/usr/lib/mapnik/3.0/input/</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c7">Adicionar arquivo de serviço aos serviços do sistema</span></p>
<p class="c0"><span class="c7"></span></p>
<p class="c2"><span class="c1"># cd /home/osm/</span></p>
<p class="c2"><span class="c1"># cp mod_tile-master/debian/renderd.init /etc/init.d/renderd</span></p>
<p class="c2"><span class="c1"># chmod a+x /etc/init.d/renderd</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c11">Alterar caminhos, usuários e arquivos </span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c1"># sed -i 's/DAEMON=\/usr\/bin\/$NAME/DAEMON=\/usr\/local\/bin\/$NAME/' /etc/init.d/renderd</span>
</p>
<p class="c2"><span class="c1"># sed -i 's/DAEMON_ARGS=""/DAEMON_ARGS=" -c \/usr\/local\/etc\/renderd.conf"/' /etc/init.d/renderd</span>
</p>
<p class="c2"><span class="c1"># sed -i 's/RUNASUSER=www-data/RUNASUSER=osm/' /etc/init.d/renderd</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c11">Criar diretório para armazenamento de metadata de cache dos Tiles</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c1"># mkdir -p /var/lib/mod_tile</span></p>
<p class="c2"><span class="c1"># chown osm:osm /var/lib/mod_tile</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c11">Recarregar gerenciador de serviços do Linux</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c1"># systemctl daemon-reload</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c7">Verificar se o serviço foi configurado</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c1"># service renderd status</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c3">Instalar o Apache2</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c1"># apt install apache2</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c7">Configurar o Apache2 para carregar Mod_Tile</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c1"># echo "LoadModule tile_module /usr/lib/apache2/modules/mod_tile.so" &gt; /etc/apache2/mods-available/tile.load</span>
</p>
<p class="c2"><span class="c1"># ln -s /etc/apache2/mods-available/tile.load /etc/apache2/mods-enabled/</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c7">Abrir configuração do Apache2</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c1"># nano /etc/apache2/sites-enabled/000-default.conf</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c11">Adicionar o seguinte trecho de código antes de "&lt;/VirtualHost&gt;"</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2 c4"><span class="c1">LoadTileConfigFile /usr/local/etc/renderd.conf</span></p>
<p class="c2 c4"><span class="c1">ModTileRenderdSocketName /var/run/renderd/renderd.sock</span></p>
<p class="c0 c4"><span class="c1"></span></p>
<p class="c2 c4"><span class="c1">##### Timeout before giving up for a tile to be rendered</span></p>
<p class="c2 c4"><span class="c1">ModTileRequestTimeout 0</span></p>
<p class="c0 c4"><span class="c1"></span></p>
<p class="c2 c4"><span
            class="c1">##### Timeout before giving up for a tile to be rendered that is otherwise missing</span></p>
<p class="c2 c4"><span class="c1">ModTileMissingRequestTimeout 30</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c7">Reiniciar o serviço do Apache2</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c1"># service apache2 restart</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c5">INSTALAR OPEN SOURCE ROUTER MACHINE (OSRM)</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c3">Instalar Nodejs</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c1"># curl -sL https://deb.nodesource.com/setup_8.x | sudo -E bash -</span></p>
<p class="c2"><span class="c1"># apt install nodejs</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c7">Iniciar projeto OSRM</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c1"># cd /home/osm</span></p>
<p class="c2"><span class="c1"># mkdir osrm-router</span></p>
<p class="c2"><span class="c1"># cd osrm-router</span></p>
<p class="c2"><span class="c1"># cp HDM-CartoCSS-master/app.js osrm-router/</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c7">Iniciar o Projeto NodeJs</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c1"># npm init</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c1">Nome do projeto: osrm-router</span></p>
<p class="c2"><span class="c1">Entry Point (main): app.js</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c7">Instalar dependencias (Dentro de /home/osm/osrm)</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c1"># npm install express</span></p>
<p class="c2"><span class="c1"># npm install path</span></p>
<p class="c2"><span class="c1"># npm install cors</span></p>
<p class="c2"><span class="c1"># npm install osrm</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c3">Extrair arquivos do osrm</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c1"># fallocate -l 100G /home/osm/swapfile</span></p>
<p class="c2"><span class="c1"># chmod 600 /home/osm/swapfile</span></p>
<p class="c2"><span class="c1"># mkswap /home/osm/swapfile</span></p>
<p class="c2"><span class="c1"># swapon /home/osm/swapfile</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c6">OBS</span><span class="c1">: Os comandos abaixo devem ser rodados dentro de uma sessão tmux</span>
</p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c1"># cd /home/osm/</span></p>
<p class="c2"><span class="c1"># mkdir osm_data</span></p>
<p class="c2"><span class="c1"># mv south-america-latest.os* osm_data/</span></p>
<p class="c2"><span class="c1"># cd osm_data/</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c1"># /home/osm/osrm-router/node_modules/osrm/lib/binding/osrm-extract -p "/home/osm/osrm-router/node_modules/osrm/profiles/car.lua" south-america-latest.osm.pbf</span>
</p>
<p class="c2"><span class="c1"># /home/osm/osrm-router/node_modules/osrm/lib/binding/osrm-contract south-america-latest.osrm</span>
</p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c3">Criar serviço do OSRM</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c1"># nano /etc/systemd/system/osrmrouter.service</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c7">Colar o código abaixo:</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2 c4"><span class="c1">[Unit]</span></p>
<p class="c2 c4"><span class="c1">Description=OSRM Router Machine NodeJs</span></p>
<p class="c0 c4"><span class="c1"></span></p>
<p class="c2 c4"><span class="c1">[Service]</span></p>
<p class="c2 c4"><span class="c1">ExecStart=/usr/bin/node /home/osm/osrm-router/app.js</span></p>
<p class="c2 c4"><span class="c1">Restart=always</span></p>
<p class="c2 c4"><span class="c1">RestartSec=5</span></p>
<p class="c2 c4"><span class="c1">Environment=PATH=/usr/bin:/usr/local/bin</span></p>
<p class="c2 c4"><span class="c1">Environment=NODE_ENV=production</span></p>
<p class="c2 c4"><span class="c1">WorkingDirectory=/home/osm/osrm-router</span></p>
<p class="c0 c4"><span class="c1"></span></p>
<p class="c2 c4"><span class="c1">[Install]</span></p>
<p class="c2 c4"><span class="c1">WantedBy=multi-user.target</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c5">INSTALAR NOMINATIM </span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c3">Instalar dependências do Nominatim</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c1"># apt install -y build-essential cmake g++ libboost-dev libboost-system-dev \</span></p>
<p class="c2"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; libboost-filesystem-dev libexpat1-dev zlib1g-dev libxml2-dev\</span>
</p>
<p class="c2"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; libbz2-dev libpq-dev libproj-dev \</span>
</p>
<p class="c2"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; postgresql-server-dev-9.6 postgresql-9.6-postgis-2.3 \</span>
</p>
<p class="c2"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; postgresql-contrib-9.6 \</span>
</p>
<p class="c2"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; apache2 php php-pgsql libapache2-mod-php php-pear php-db \</span>
</p>
<p class="c2"><span class="c1">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; php-intl</span>
</p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c3">Criar usuário nominatim</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c1"># useradd -d /srv/nominatim -s /bin/bash -m nominatim</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c7">Exportar usuário e diretório home para prosseguir com os comandos</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c1"># export USERNAME=nominatim</span></p>
<p class="c2"><span class="c1"># export USERHOME=/srv/nominatim</span></p>
<p class="c2"><span class="c1"># chmod a+x $USERHOME</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c7">Editar arquivo de configuração do postgres</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c1"># nano /etc/postgresql/9.6/main/postgresql.conf</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span
            class="c7">Procurar por cada chave abaixo e configurar a quantidade em relação a RAM disponível</span></p>
<p class="c2"><span class="c6 c11">Ex</span><span class="c7">: No caso da máquina ter 20GB de RAM</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2 c4"><span class="c1">shared_buffers = 8GB (40% da RAM)</span></p>
<p class="c2 c4"><span class="c1">maintenance_work_mem 8GB (40% da RAM)</span></p>
<p class="c2 c4"><span class="c1">work_mem = 50MB</span></p>
<p class="c2 c4"><span class="c1">effective_cache_size = 8GB (40% da RAM)</span></p>
<p class="c2 c4"><span class="c1">max_wal_size = 8GB (40% da RAM)</span></p>
<p class="c2 c4"><span class="c1">synchronous_commit = off</span></p>
<p class="c2 c4"><span class="c1">checkpoint_timeout = 10min</span></p>
<p class="c2 c4"><span class="c1">checkpoint_completion_target = 0.9</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c6">OBS</span><span class="c1">: para melhorar o desempenho do primeiro import de dados, desativar as seguintes configurações:</span>
</p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c6">ATENÇÃO</span><span class="c1">: estas configurações devem ser ativadas logo após o import, </span>
</p>
<p class="c2"><span class="c1">caso contrário a base terá risco de ser CORROMPIDA!</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2 c4"><span class="c1">fsync = off</span></p>
<p class="c2 c4"><span class="c1">full_page_writes = off</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c7">Salvar e fechar o arquivo</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c3">Reiniciar o Postgres para carregar novas configurações</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c1"># service postgresql restart</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c7">Criar os usuários que irão respectivamente importar os dados para a base e requisitar os dados</span>
</p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c1"># su postgres</span></p>
<p class="c2"><span class="c1">$ createuser -s $USERNAME</span></p>
<p class="c2"><span class="c1">$ createuser www-data</span></p>
<p class="c2"><span class="c1">$ exit</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c1"># tee /etc/apache2/conf-available/nominatim.conf &lt;&lt; EOFAPACHECONF</span></p>
<p class="c2"><span class="c1">&lt;Directory "$USERHOME/Nominatim-3.1.0/build/website"&gt;</span></p>
<p class="c2"><span class="c1">&nbsp; Options FollowSymLinks MultiViews</span></p>
<p class="c2"><span class="c1">&nbsp; AddType text/html &nbsp; .php</span></p>
<p class="c2"><span class="c1">&nbsp; DirectoryIndex search.php</span></p>
<p class="c2"><span class="c1">&nbsp; Require all granted</span></p>
<p class="c2"><span class="c1">&lt;/Directory&gt;</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c1">Alias /nominatim $USERHOME/Nominatim-3.1.0/build/website</span></p>
<p class="c2"><span class="c1">EOFAPACHECONF</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c1"># ln -s /etc/apache2/conf-available/nominatim.conf /etc/apache2/conf-enabled/</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c7">Instalar Nominatim</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c1"># cd $USERHOME</span></p>
<p class="c2"><span class="c1"># wget https://nominatim.org/release/Nominatim-3.1.0.tar.bz2</span></p>
<p class="c2"><span class="c1"># tar xf Nominatim-3.1.0.tar.bz2</span></p>
<p class="c2"><span class="c1"># cd Nominatim-3.1.0</span></p>
<p class="c2"><span
            class="c1"># wget -O data/country_osm_grid.sql.gz https://www.nominatim.org/data/country_grid.sql.gz</span>
</p>
<p class="c2"><span class="c1"># mkdir build</span></p>
<p class="c2"><span class="c1"># cd build</span></p>
<p class="c2"><span class="c1"># cmake ..</span></p>
<p class="c2"><span class="c1"># make</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c1"># tee settings/local.php &lt;&lt; EOF</span></p>
<p class="c2"><span class="c1">&lt;?php</span></p>
<p class="c2"><span class="c1">&nbsp;@define('CONST_Website_BaseURL', '/nominatim/');</span></p>
<p class="c2"><span class="c1">&nbsp;@define('CONST_Osm2pgsql_Flatnode_File', '/srv/nominatim/flatnode.file');</span>
</p>
<p class="c2"><span class="c1">EOF</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c1"># cd /srv/nominatim/Nominatim-3.1.0/data</span></p>
<p class="c2"><span class="c1"># wget https://www.nominatim.org/data/wikipedia_article.sql.bin</span></p>
<p class="c2"><span class="c1"># wget https://www.nominatim.org/data/wikipedia_redirect.sql.bin</span></p>
<p class="c2"><span class="c1"># cd /srv/nominatim/Nominatim-3.1.0/build/</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c8 c6">Nunca, NUNCA MESMO, instale o Nominatim como root.</span></p>
<p class="c2"><span class="c1"># su nominatim</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c6">OBS</span><span class="c1">: No comando abaixo a opção --osm2pgsql-cache pode ser a mesma utilizada no import de dados do osm</span>
</p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c1"># ./utils/setup.php --osm-file /home/osm/osm_data/south-america-latest.osm.pbf --all --osm2pgsql-cache 17000 2&gt;&amp;1 | tee setup.log</span>
</p>
<p class="c0"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c7">Editar arquivo de configuração do postgres</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span># nano /etc/postgresql/9.6/main/postgresql.conf</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c11">Reativar as seguintes opções</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2 c4"><span class="c1">fsync = on</span></p>
<p class="c2 c4"><span>full_page_writes = on</span></p>
<p class="c0 c4"><span class="c1"></span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c7">Salvar e fechar o arquivo</span></p>
<p class="c2"><span class="c7">Reiniciar o serviço do Postgres</span></p>
<p class="c0"><span class="c1"></span></p>
<p class="c2"><span class="c1"># service postgresql restart</span></p></body>
</html>
